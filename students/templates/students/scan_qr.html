{% extends 'students/basetemp.html' %}

{% block title %}Scan QR - Meal Tracker{% endblock title %}

{% block content %}
<style>
  /* === Scanner Styles === */
  .scanner-container {
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    border-radius: 20px;
    padding: 2rem;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    margin-bottom: 2rem;
  }
  
  .scanner-header {
    text-align: center;
    color: white;
    margin-bottom: 1.5rem;
  }
  
  .scanner-header h2 {
    margin-bottom: 0.5rem;
    font-weight: 600;
  }
  
  .scanner-header p {
    margin: 0;
    opacity: 0.9;
  }
  
  #reader {
    width: 100%;
    max-width: 400px;
    height: 400px;
    margin: 0 auto;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
    background: #f8f9fa;
    position: relative;
  }
  
  .scan-guide {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 70%;
    height: 70%;
    border: 2px dashed rgba(255, 255, 255, 0.7);
    border-radius: 12px;
    pointer-events: none;
    z-index: 10;
  }
  
  .scan-guide::before {
    content: "Position QR code here";
    position: absolute;
    bottom: -40px;
    left: 50%;
    transform: translateX(-50%);
    color: white;
    font-weight: 500;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    white-space: nowrap;
  }
  
  .scan-animation {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 4px;
    background: linear-gradient(90deg, transparent, var(--accent), transparent);
    animation: scanLine 2s infinite linear;
    border-radius: 4px;
  }
  
  @keyframes scanLine {
    0% { top: 0; }
    100% { top: 100%; }
  }
  
  .meal-selector,
  .camera-selector {
    text-align: center;
    margin-bottom: 1rem;
  }
  
  .meal-selector label,
  .camera-selector label {
    color: white;
    font-weight: 600;
  }
  
  .camera-selector {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    flex-wrap: wrap;
  }
  
  #live-output {
    background: white;
    padding: 12px 20px;
    border-radius: 30px;
    margin: 20px auto 0;
    max-width: 400px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
    font-weight: 600;
    color: #6c757d;
  }
  
  #student-info-card {
    background: white;
    border-radius: 20px;
    padding: 2rem;
    box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
    margin-top: 2rem;
    display: none;
  }
  
  #student-photo {
    width: 150px;
    height: 150px;
    object-fit: cover;
    border-radius: 50%;
    border: 4px solid #e0e7ff;
    box-shadow: 0 10px 20px rgba(67, 97, 238, 0.2);
    margin: 0 auto 1rem;
    display: block;
  }
  
  .status-badge {
    padding: 12px 20px;
    border-radius: 12px;
    font-weight: 600;
    display: inline-block;
  }
  
  /* Responsive adjustments */
  @media (max-width: 576px) {
    #reader {
      height: 300px;
      max-width: 100%;
    }
    
    .scanner-container {
      padding: 1.5rem;
    }
  }
</style>

<div class="container py-4">
  <div class="scanner-container position-relative overflow-hidden">
    <div class="scanner-header">
      <h2><i class="bi bi-qr-code-scan me-2"></i>Scan Student QR Code</h2>
      <p>Position the QR code within the frame to scan</p>
      <div style="margin-top:0.75rem;">
        <a href="{% url 'manual_check' %}" class="btn btn-success btn-sm">
          <i class="bi bi-search me-1"></i> Manual Lookup
        </a>
      </div>
    </div>

    <!-- Meal Type Selector -->
    <div class="meal-selector">
      <label for="meal-type" class="form-label mb-2">Select Meal Type:</label>
      <select id="meal-type" class="form-select mx-auto" style="max-width: 250px;">
        <option value="breakfast">üç≥ Breakfast</option>
        <option value="lunch">üç≤ Lunch</option>
        <option value="dinner">üçõ Dinner</option>
        <option value="night_snack">ü•™ Night Snack</option>
      </select>
    </div>

    <!-- Camera Selector -->
    <div class="camera-selector">
      <label for="camera-select" class="form-label mb-0">Camera:</label>
      <select id="camera-select" class="form-select" style="max-width: 250px;">
        <option value="">Loading cameras...</option>
      </select>
      <button class="btn btn-outline-light btn-sm" id="switch-camera" title="Switch camera">
        <i class="bi bi-camera-video"></i> Switch
      </button>
    </div>

    <!-- QR Scanner -->
    <div class="position-relative">
      <div id="reader"></div>
      <div class="scan-guide"></div>
      <div class="scan-animation"></div>
    </div>

    <p id="live-output">
      <i class="bi bi-info-circle me-2"></i>Waiting for QR code scan...
    </p>
  </div>

  <!-- Student Info Card -->
  <div id="student-info-card" class="text-center">
    <img id="student-photo" src="" alt="Student Photo">
  <h4 id="student-name" class="mb-2 text-primary"></h4>
    <p id="student-class" class="text-muted mb-3"></p>

    <div id="status-message" class="status-badge bg-primary text-white"></div>

    <div class="text-center mt-4">
      <button id="rescan-btn" class="btn btn-primary btn-lg" style="display: none;">
        <i class="bi bi-arrow-repeat me-2"></i> Scan Another Student
      </button>
    </div>
  </div>
</div>
{% endblock content %}

{% block extra_js %}
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script>
  // Global variables
  let scanner = null;
  let selectedCameraId = null;
  let currentMealType = "breakfast";
  let cameras = [];
  let currentCameraIndex = 0;
  let lastScannedCode = null;
  let isScanning = false;

  // DOM Elements
  const mealTypeSelect = document.getElementById("meal-type");
  const cameraSelect = document.getElementById("camera-select");
  const switchCameraBtn = document.getElementById("switch-camera");
  const liveOutput = document.getElementById("live-output");
  const studentInfoCard = document.getElementById("student-info-card");
  const studentName = document.getElementById("student-name");
  const studentClass = document.getElementById("student-class");
  const studentPhoto = document.getElementById("student-photo");
  const statusMessage = document.getElementById("status-message");
  const rescanBtn = document.getElementById("rescan-btn");

  // Event Listeners
  mealTypeSelect.addEventListener("change", function () {
    currentMealType = this.value;
  });

  switchCameraBtn.addEventListener("click", handleSwitchCamera);
  rescanBtn.addEventListener("click", handleRescan);

  // Initialize
  document.addEventListener("DOMContentLoaded", function () {
    initializeScanner();
  });

  // Initialize scanner
  async function initializeScanner() {
    try {
      await loadCameras();
    } catch (err) {
      console.error("Initialization error:", err);
      setStatus("‚ùå Failed to initialize scanner: " + err.message, "danger");
    }
  }

  // Load available cameras
  async function loadCameras() {
    try {
      const devices = await Html5Qrcode.getCameras();
      
      if (!devices || devices.length === 0) {
        setStatus("‚ùå No camera devices found.", "danger");
        return;
      }

      cameras = devices;
      populateCameraSelect(devices);

      // Prefer back camera
      let backCameraIndex = devices.findIndex(device =>
        device.label && (
          device.label.toLowerCase().includes("back") ||
          device.label.toLowerCase().includes("rear") ||
          device.label.toLowerCase().includes("environment")
        )
      );

      if (backCameraIndex === -1) backCameraIndex = 0;

      selectedCameraId = devices[backCameraIndex].id;
      currentCameraIndex = backCameraIndex;
      
      await startScanner();
    } catch (err) {
      console.error("Camera loading error:", err);
      setStatus("‚ùå Unable to access camera: " + err.message, "danger");
    }
  }

  // Populate camera dropdown
  function populateCameraSelect(devices) {
    cameraSelect.innerHTML = "";

    devices.forEach((device, index) => {
      const option = document.createElement("option");
      option.value = device.id;
      option.textContent = device.label || `Camera ${index + 1}`;
      option.selected = index === currentCameraIndex;
      cameraSelect.appendChild(option);
    });

    cameraSelect.addEventListener("change", async function () {
      selectedCameraId = this.value;
      currentCameraIndex = cameras.findIndex(cam => cam.id === selectedCameraId);
      await restartScanner();
    });
  }

  // Handle camera switch button
  async function handleSwitchCamera() {
    if (cameras.length <= 1) {
      setStatus("‚ö†Ô∏è Only one camera available", "warning");
      return;
    }
    
    currentCameraIndex = (currentCameraIndex + 1) % cameras.length;
    selectedCameraId = cameras[currentCameraIndex].id;
    cameraSelect.value = selectedCameraId;
    await restartScanner();
  }

  // Start scanner
  async function startScanner() {
    if (!selectedCameraId) {
      console.error("No camera selected");
      return;
    }

    try {
      scanner = new Html5Qrcode("reader");
      isScanning = true;

      await scanner.start(
        selectedCameraId,
        {
          fps: 10,
          qrbox: { width: 250, height: 250 },
          aspectRatio: 1.0
        },
        onScanSuccess,
        onScanFailure
      );
    } catch (err) {
      console.error("Scanner start error:", err);
      isScanning = false;
      setStatus("‚ùå Camera error: " + err.message, "danger");
    }
  }

  // Stop scanner properly
  async function stopScanner() {
    if (!scanner || !isScanning) return;

    try {
      await scanner.stop();
      scanner.clear();
      isScanning = false;
    } catch (err) {
      console.error("Scanner stop error:", err);
      // Force clear even if stop fails
      try {
        scanner.clear();
      } catch (clearErr) {
        console.error("Scanner clear error:", clearErr);
      }
      isScanning = false;
    }
  }

  // Restart scanner
  async function restartScanner() {
    await stopScanner();
    
    // Wait for camera to be fully released
    await new Promise(resolve => setTimeout(resolve, 200));
    
    await startScanner();
  }

  // Handle successful scan
  async function onScanSuccess(decodedText) {
    const qrCode = decodedText.trim();

    // Prevent duplicate scans
    if (!qrCode || qrCode === lastScannedCode) return;
    
    lastScannedCode = qrCode;

    // Stop scanner
    await stopScanner();

    // Update UI
    liveOutput.innerHTML = '<i class="bi bi-check-circle-fill me-2 text-success"></i>QR Code Scanned Successfully!';
    liveOutput.style.color = "#198754";

    try {
      // Fetch student info
      const studentResponse = await fetch(`/api/student/${encodeURIComponent(qrCode)}/`);
      
      if (!studentResponse.ok) {
        throw new Error(`Student not found (${studentResponse.status})`);
      }
      
      const student = await studentResponse.json();

      // Display student details
      studentName.textContent = student.name || "Unknown Student";
      studentClass.textContent = student.class_name || "Unknown Class";
      studentPhoto.src = student.photo_url || "/static/images/default-avatar.png";
      studentPhoto.onerror = function() {
        this.src = "/static/images/default-avatar.png";
      };
      studentInfoCard.style.display = "block";

      // Mark feeding
      const feedResponse = await fetch(`/api/mark-fed/${encodeURIComponent(qrCode)}/`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken"),
        },
        body: JSON.stringify({ meal_type: currentMealType }),
      });

      const feedData = await feedResponse.json();

      if (feedData.status === "success") {
        setStatus(
          `<i class="bi bi-check-circle-fill me-2"></i>Meal recorded successfully for ${currentMealType}`,
          "success"
        );
      } else if (feedData.status === "already_fed") {
        setStatus(
          `<i class="bi bi-exclamation-triangle-fill me-2"></i>Student already fed for this meal today`,
          "warning"
        );
      } else {
        setStatus(
          `<i class="bi bi-x-circle-fill me-2"></i>Error: ${feedData.message || "Unknown error"}`,
          "danger"
        );
      }

      // Show rescan button
      rescanBtn.style.display = "inline-block";

    } catch (err) {
      console.error("Scan processing error:", err);
      setStatus(
        `<i class="bi bi-x-circle-fill me-2"></i>Error: ${err.message}`,
        "danger"
      );
      
      // Show rescan button even on error
      rescanBtn.style.display = "inline-block";
    }
  }

  // Handle scan failure (ignore continuous errors)
  function onScanFailure(error) {
    // Silent - this fires constantly while scanning
  }

  // Handle rescan button click
  async function handleRescan() {
    lastScannedCode = null;
    studentInfoCard.style.display = "none";
    rescanBtn.style.display = "none";
    
    liveOutput.innerHTML = '<i class="bi bi-info-circle me-2"></i>Waiting for QR code scan...';
    liveOutput.style.color = "#6c757d";
    
    statusMessage.innerHTML = "";
    statusMessage.className = "status-badge";

    await restartScanner();
  }

  // Set status message
  function setStatus(message, type) {
    const bgClass = `bg-${type}`;
    statusMessage.innerHTML = message;
    statusMessage.className = `status-badge ${bgClass} text-white`;
  }

  // Get CSRF token from cookies
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === name + "=") {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  // Cleanup on page unload
  window.addEventListener("beforeunload", async function() {
    await stopScanner();
  });
</script>

{% endblock extra_js %}