{% extends 'students/basetemp.html' %}

{% block title %}Scan QR - Meal Tracker{% endblock title %}

{% block content %}
<style>
  /* === Scanner Styles === */
  .scanner-container {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 20px;
    padding: 2rem;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    margin-bottom: 2rem;
  }
  #reader {
    width: 100%;
    max-width: 400px;
    height: 400px;
    margin: 0 auto;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
    background: #f8f9fa;
    position: relative;
  }
  .scan-guide {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 70%; height: 70%;
    border: 2px dashed rgba(255, 255, 255, 0.7);
    border-radius: 12px;
    pointer-events: none;
    z-index: 10;
    display: flex; align-items: center; justify-content: center;
  }
  .scan-guide::before {
    content: "Position QR code here";
    position: absolute;
    bottom: -40px;
    left: 50%;
    transform: translateX(-50%);
    color: white; font-weight: 500;
    text-shadow: 0 2px 4px rgba(0,0,0,0.3);
  }
  .scan-animation {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 4px;
    background: linear-gradient(90deg, transparent, #4361ee, transparent);
    animation: scanLine 2s infinite linear;
    border-radius: 4px;
  }
  @keyframes scanLine {
    0% { top: 0; }
    100% { top: 100%; }
  }
  #live-output {
    background: white;
    padding: 12px 20px;
    border-radius: 30px;
    margin: 20px auto;
    max-width: 400px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    font-weight: 600;
  }
  #student-info-card {
    background: white;
    border-radius: 20px;
    padding: 2rem;
    box-shadow: 0 15px 30px rgba(0,0,0,0.1);
    margin-top: 2rem;
    display: none;
  }
  #student-photo {
    width: 150px; height: 150px;
    object-fit: cover;
    border-radius: 50%;
    border: 4px solid #e0e7ff;
    box-shadow: 0 10px 20px rgba(67, 97, 238, 0.2);
    margin: 0 auto 1rem;
    display: block;
  }
</style>

<div class="container py-4">
  <div class="scanner-container position-relative overflow-hidden">
    <div class="scanner-header text-center text-white mb-4">
      <h2><i class="bi bi-qr-code-scan me-2"></i>Scan Student QR Code</h2>
      <p>Position the QR code within the frame to scan</p>
    </div>

    <!-- ‚úÖ Meal Type Selector -->
    <div class="meal-selector text-center mb-3">
      <label for="meal-type" class="form-label fw-semibold mb-2">Select Meal Type:</label>
      <select id="meal-type" class="form-select mx-auto" style="max-width:250px;">
        <option value="breakfast">üç≥ Breakfast</option>
        <option value="lunch">üç≤ Lunch</option>
        <option value="dinner">üçõ Dinner</option>
        <option value="night_snack">ü•™ Night Snack</option>
      </select>
    </div>

    <!-- ‚úÖ Camera Selector -->
    <div class="camera-selector text-center mb-3">
      <label for="camera-select" class="form-label fw-semibold mb-0 me-2">Camera:</label>
      <select id="camera-select" class="form-select me-2" style="max-width:250px;">
        <option value="">Loading cameras...</option>
      </select>
      <button class="btn btn-outline-primary btn-sm" id="switch-camera" title="Switch camera">
        <i class="bi bi-camera-video"></i>
      </button>
    </div>

    <!-- ‚úÖ QR Scanner -->
    <div class="position-relative">
      <div id="reader"></div>
      <div class="scan-guide"></div>
      <div class="scan-animation"></div>
    </div>

    <p id="live-output" class="text-center mt-3">
      <i class="bi bi-info-circle me-2"></i>Waiting for QR code scan...
    </p>
  </div>

  <!-- ‚úÖ Student Info -->
  <div id="student-info-card" class="text-center">
    <h4 id="student-name" class="mb-2 text-primary"></h4>
    <p id="student-class" class="text-muted mb-3"></p>
    <img id="student-photo" src="" alt="Student Photo">

    <div id="status-message" class="status-badge bg-primary text-white mt-3"></div>

    <div class="text-center mt-4">
      <button id="rescan-btn" onclick="restartScanner()" class="btn btn-primary" style="display:none;">
        <i class="bi bi-arrow-repeat me-2"></i> Scan Another Student
      </button>
    </div>
  </div>
</div>
{% endblock content %}

{% block extra_js %}
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script>
  let scanner;
  let selectedCameraId;
  let currentMealType = "breakfast";
  let cameras = [];
  let currentCameraIndex = 0;
  let lastScannedCode = null;

  // ‚úÖ Meal type change
  document.getElementById("meal-type").addEventListener("change", function () {
    currentMealType = this.value;
  });

  // ‚úÖ Switch camera button
  document.getElementById("switch-camera").addEventListener("click", switchCamera);

  // ‚úÖ Load cameras
  function loadCameras() {
    Html5Qrcode.getCameras()
      .then((devices) => {
        if (devices.length === 0) {
          setStatus("‚ùå No camera devices found.", "danger");
          return;
        }

        cameras = devices;
        populateCameraSelect(devices);

        // Prefer back camera
        let backCameraIndex = devices.findIndex(
          (device) =>
            device.label.toLowerCase().includes("back") ||
            device.label.toLowerCase().includes("rear")
        );

        if (backCameraIndex === -1) backCameraIndex = 0;

        selectedCameraId = devices[backCameraIndex].id;
        currentCameraIndex = backCameraIndex;
        startScanner();
      })
      .catch((err) => {
        setStatus("‚ùå Unable to access camera: " + err, "danger");
      });
  }

  // ‚úÖ Populate camera dropdown
  function populateCameraSelect(devices) {
    const select = document.getElementById("camera-select");
    select.innerHTML = "";

    devices.forEach((device, index) => {
      const option = document.createElement("option");
      option.value = device.id;
      option.text = device.label || `Camera ${index + 1}`;
      option.selected = index === currentCameraIndex;
      select.appendChild(option);
    });

    select.addEventListener("change", function () {
      selectedCameraId = this.value;
      currentCameraIndex = cameras.findIndex(
        (cam) => cam.id === selectedCameraId
      );
      restartScanner();
    });
  }

  // ‚úÖ Switch camera
  function switchCamera() {
    if (cameras.length <= 1) return;
    currentCameraIndex = (currentCameraIndex + 1) % cameras.length;
    selectedCameraId = cameras[currentCameraIndex].id;
    document.getElementById("camera-select").value = selectedCameraId;
    restartScanner();
  }

  // ‚úÖ Start scanner
  function startScanner() {
    if (scanner) {
      scanner.stop()
        .then(() => scanner.clear())
        .catch(() => {});
    }

    scanner = new Html5Qrcode("reader");
    scanner
      .start(
        selectedCameraId,
        { fps: 10, qrbox: { width: 250, height: 250 }, aspectRatio: 1.0 },
        onScanSuccess,
        (errorMessage) => {
          // ignore continuous scan errors
        }
      )
      .catch((err) => {
        setStatus("‚ùå Camera error: " + err, "danger");
      });
  }

  // ‚úÖ Handle successful scan
  async function onScanSuccess(decodedText) {
    const qrCode = decodedText.trim();

    if (!qrCode || qrCode === lastScannedCode) return;
    lastScannedCode = qrCode;

    // Fully stop and clear scanner
    scanner.stop()
      .then(() => scanner.clear())
      .catch(() => {});

    document.getElementById("live-output").innerHTML =
      '<i class="bi bi-check-circle-fill me-2 text-success"></i>QR Code Scanned Successfully!';
    document.getElementById("live-output").style.color = "#198754";

    try {
      // 1. Get Student Info
      const res = await fetch(`/api/student/${qrCode}/`);
      if (!res.ok) throw new Error("Student not found");
      const student = await res.json();

      // Show student details
      document.getElementById("student-name").textContent = student.name;
      document.getElementById("student-class").textContent = student.class_name;
      document.getElementById("student-photo").src = student.photo_url || "";
      document.getElementById("student-info-card").style.display = "block";

      // 2. Mark feeding
      const feedRes = await fetch(`/api/mark-fed/${qrCode}/`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken"),
        },
        body: JSON.stringify({ meal_type: currentMealType }),
      });

      const data = await feedRes.json();
      if (data.status === "success") {
        setStatus(
          `<i class="bi bi-check-circle-fill me-2"></i>Meal recorded for ${currentMealType}`,
          "success"
        );
      } else if (data.status === "already_fed") {
        setStatus("‚ö†Ô∏è Student already fed for this meal today", "warning");
      } else {
        setStatus("‚ùå Error: " + (data.message || "Unknown error"), "danger");
      }

      // ‚úÖ Show "Next Scan" button
      document.getElementById("rescan-btn").style.display = "inline-block";
    } catch (err) {
      console.error(err);
      setStatus("‚ùå Error: " + err.message, "danger");
    }
  }

  // ‚úÖ Restart scanner
  function restartScanner() {
    lastScannedCode = null;
    document.getElementById("student-info-card").style.display = "none";
    document.getElementById("live-output").innerHTML =
      '<i class="bi bi-info-circle me-2"></i>Waiting for QR code scan...';
    document.getElementById("live-output").style.color = "#6c757d";
    document.getElementById("rescan-btn").style.display = "none";

    startScanner(); // Fresh start
  }

  // ‚úÖ Status message helper
  function setStatus(message, type) {
    const status = document.getElementById("status-message");
    status.innerHTML = message;
    status.className = `status-badge bg-${type} text-white`;
  }

  // ‚úÖ Get CSRF token
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === name + "=") {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  // ‚úÖ Init
  document.addEventListener("DOMContentLoaded", function () {
    loadCameras();
    document.getElementById("rescan-btn").addEventListener("click", restartScanner);
  });
</script>


{% endblock extra_js %}
